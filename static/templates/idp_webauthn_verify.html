{{ define "content" }}
<div class="flex justify-center items-center mt-10">
    <div class="card w-full max-w-lg bg-base-100 shadow-xl">
        <div class="card-body items-center text-center">
            <h2 class="card-title text-2xl mb-4">{{ .Title }}</h2>

            <p class="mb-8">{{ .WebAuthnVerifyMessage }}</p>

            <div class="alert alert-info hidden mb-6" id="webauthn-status">
                <svg class="stroke-current shrink-0 w-6 h-6" fill="none" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="2"></path>
                </svg>
                <span id="status-text">{{ .JSInteractWithKey }}</span>
            </div>

            <div class="alert alert-error hidden mb-6" id="webauthn-error">
                <svg class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="2"/>
                </svg>
                <span id="error-text"></span>
            </div>

            <button class="btn btn-primary btn-lg w-full" id="login-button">
                {{ .Submit }}
            </button>
        </div>
    </div>
</div>

<script>
    const ab_to_b64 = bin => {
        const uint8array = new Uint8Array(bin)
        const str = btoa(String.fromCharCode(...uint8array))

        return str
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=/g, "")
    }

    const b64_to_uint8array = b64str => {
        const len = b64str.length

        b64str = b64str
            .replace(/-/g, "+")
            .replace(/_/g, "/")
            .padEnd(len + ((4 - len % 4) % 4), "=")

        return new Uint8Array([...atob(b64str)].map((e) => e.charCodeAt(0)))
    }

    document.getElementById('login-button').addEventListener('click', async () => {
        const statusDiv = document.getElementById('webauthn-status');
        const statusText = document.getElementById('status-text');
        const errorDiv = document.getElementById('webauthn-error');
        const errorText = document.getElementById('error-text');
        const button = document.getElementById('login-button');

        statusDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        button.disabled = true;

        try {
            // 1. Begin Login
            const response = await fetch("/login/webauthn/begin");
            if (!response.ok) {
                throw new Error(await response.text());
            }

            const options = await response.json();

            // Prepare options for navigator.credentials.get
            options.publicKey.challenge = b64_to_uint8array(options.publicKey.challenge);
            if (options.publicKey.allowCredentials) {
                options.publicKey.allowCredentials.forEach(c => {
                    c.id = b64_to_uint8array(c.id);
                });
            }

            // 2. Get Assertion
            const assertion = await navigator.credentials.get({
                publicKey: options.publicKey
            });

            // 3. Finish Login
            statusText.innerText = "{{ .JSCompletingLogin }}";

            const finishResponse = await fetch("/login/webauthn/finish", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    id: assertion.id,
                    rawId: ab_to_b64(assertion.rawId),
                    type: assertion.type,
                    response: {
                        authenticatorData: ab_to_b64(assertion.response.authenticatorData),
                        clientDataJSON: ab_to_b64(assertion.response.clientDataJSON),
                        signature: ab_to_b64(assertion.response.signature),
                        userHandle: assertion.response.userHandle ? ab_to_b64(assertion.response.userHandle) : null,
                    }
                })
            });

            if (!finishResponse.ok) {
                throw new Error(await finishResponse.text());
            }

            // Success!
            const returnTo = new URLSearchParams(window.location.search).get('return_to') || '/';
            window.location.href = returnTo;

        } catch (err) {
            console.error(err);
            errorDiv.classList.remove('hidden');
            errorText.innerText = err.message || "{{ .JSUnknownError }}";
            statusDiv.classList.add('hidden');
            button.disabled = false;
        }
    });
</script>
{{ end }}

{{ template "idp_base.html" . }}
